name: Compliance Check

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  compliance:
    name: Compliance Check   # THIS MUST MATCH BRANCH PROTECTION EXACTLY
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      checks: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # we need history for churn analysis

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install ReleaseGate
        run: |
          pip install --upgrade pip
          pip install -e .

      - name: Debug Environment
        run: |
          pip list
          which releasegate || echo "releasegate not in PATH"
          releasegate --help || echo "releasegate failed to run"

      - name: Run Policy Analysis
        env:
          # Use the built-in GITHUB_TOKEN for API access logic in cli.py
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Report-only mode for now
          COMPLIANCEBOT_ENFORCEMENT: report_only
        run: |
          echo "Running ReleaseGate analysis for PR #${{ github.event.pull_request.number }}"
          
          releasegate evaluate \
            --repo "${{ github.repository }}" \
            --pr "${{ github.event.pull_request.number }}" \
            --format json > compliance_report.json
