name: RiskBot CI

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  riskbot:
    name: RiskBot CI
    runs-on: ubuntu-latest
    steps:
      - name: Call RiskBot CI Score
        env:
          WEBHOOK_URL: ${{ secrets.RISKBOT_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          PR: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail

          if [ -z "${WEBHOOK_URL:-}" ]; then
            echo "ERROR: RISKBOT_WEBHOOK_URL secret is not set."
            exit 2
          fi

          # Robust URL construction
          # Remove trailing slash if present
          CLEAN_URL=${WEBHOOK_URL%/}
          # Remove /webhooks/github suffix if present
          BASE_URL=${CLEAN_URL%/webhooks/github}
          # Ensure no trailing slash on base
          BASE_URL=${BASE_URL%/}
          
          CI_URL="${BASE_URL}/ci/score"
          
          echo "Debug: Constructed URL: $CI_URL"
          
          # Send JSON payload and capture HTTP code
          # -s: silent, -w: write-out http_code
          response=$(curl -s -w "\n%{http_code}" -X POST "$CI_URL" \
            -H "Content-Type: application/json" \
            -d "{\"repo\": \"$REPO\", \"pr\": $PR}")
            
          # Split body and status (last line is status)
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Status: $http_code"
          echo "Raw response: $body"

          if [ "$http_code" != "200" ]; then
             echo "❌ API Call Failed. Check your URL."
             if [[ "$body" == *"DOCTYPE html"* ]]; then
                 echo "⚠️ Response looks like HTML (likely ngrok error page). Check if Uvicorn is running."
             fi
             exit 1
          fi

          # Parse level using jq (Standard, robust)
          # We try 'level' first, then 'risk_level'
          level=$(echo "$body" | jq -r '.level // .risk_level // empty')
          # Normalize to uppercase
          level=$(echo "$level" | tr '[:lower:]' '[:upper:]')

          echo "Parsed level: $level"

          if [ "$level" = "HIGH" ]; then
            echo "❌ HIGH risk — blocking merge"
            exit 1
          fi

          if [ "$level" = "BYPASSED" ]; then
             echo "⚠️ HIGH risk but BYPASSED — passing"
             exit 0
          fi
          
          if [ -z "$level" ]; then
             echo "❌ Could not parse risk level from response."
             exit 1
          fi

          echo "✅ $level risk — passing"
