name: RiskBot CI

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  riskbot:
    name: RiskBot CI
    runs-on: ubuntu-latest

    steps:
      - name: Call RiskBot CI Score
        env:
          WEBHOOK_BASE: ${{ secrets.RISKBOT_WEBHOOK_URL }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          # Sanitize WEBHOOK_BASE: remove newlines/returns and leading/trailing whitespace
          WEBHOOK_BASE=$(echo "$WEBHOOK_BASE" | tr -d '\n' | tr -d '\r' | xargs)

          # Robustly handle if user included "/webhooks/github" in the secret
          BASE_CLEAN=${WEBHOOK_BASE%/}
          BASE_CLEAN=${BASE_CLEAN%/webhooks/github}
          BASE_CLEAN=${BASE_CLEAN%/}

          # Construct final URL
          URL="${BASE_CLEAN}/ci/score"
          echo "Debug: Constructed URL: $URL"

          # Call RiskBot (ngrok header avoids ngrok HTML warning page)
          resp="$(curl -sS -X POST "$URL" \
            -H "Content-Type: application/json" \
            -H "ngrok-skip-browser-warning: true" \
            -d "{\"repo\":\"$REPO\",\"pr\":$PR_NUMBER,\"sha\":\"$SHA\"}")"

          echo "Raw response:"
          echo "$resp"

          # Parse Fields
          level="$(echo "$resp" | jq -r '.level // empty')"
          score="$(echo "$resp" | jq -r '.score // 0')"
          prob="$(echo "$resp" | jq -r '.probability // 0')"
          
          # Print Summary
          echo "----------------------------------------"
          echo "RISK ANALYSIS SUMMARY"
          echo "----------------------------------------"
          echo "Score: $score / 100"
          echo "Level: $level"
          echo "Prob:  $prob"
          echo ""
          echo "Top Reasons:"
          echo "$resp" | jq -r '.reasons[]' | sed 's/^/- /'
          echo "----------------------------------------"

          # Fail Condition: HIGH Risk OR Probability > 75%
          threshold_prob=0.75
          
          if [ "$level" = "HIGH" ]; then
            echo "❌ FAILED: Risk Level is HIGH"
            exit 1
          fi
          
          # Bash float comparison hack
          if (( $(echo "$prob > $threshold_prob" | bc -l) )); then
             echo "❌ FAILED: Risk Probability $prob > $threshold_prob"
             exit 1
          fi

          echo "✅ PASSED: Risk acceptable."
