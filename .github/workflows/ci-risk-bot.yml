name: RiskBot CI

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  riskbot:
    name: RiskBot CI
    runs-on: ubuntu-latest
    steps:
      - name: Call RiskBot CI Score
        env:
          WEBHOOK_URL: ${{ secrets.RISKBOT_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          PR: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail

          if [ -z "${WEBHOOK_URL:-}" ]; then
            echo "ERROR: RISKBOT_WEBHOOK_URL secret is not set."
            exit 2
          fi

          # Construct CI Endpoint URL (replace /webhooks/github with /ci/score)
          # We do this to ensure we hit the correct endpoint even if secret has old path
          BASE_URL=${WEBHOOK_URL%/webhooks/github}
          CI_URL="${BASE_URL}/ci/score"
          
          echo "Calling RiskBot at $CI_URL"
          
          # Send JSON payload
          resp=$(curl -sS -X POST "$CI_URL" \
            -H "Content-Type: application/json" \
            -d "{\"repo\": \"$REPO\", \"pr\": $PR}")

          echo "Raw response:"
          echo "$resp"

          # Parse level using python one-liner to avoid YAML syntax issues with heredocs
          level=$(echo "$resp" | python3 -c "import sys, json; data=json.load(sys.stdin); print((data.get('level') or data.get('risk_level') or '').upper())")

          echo "Parsed level: $level"

          if [ "$level" = "HIGH" ]; then
            echo "❌ HIGH risk — blocking merge"
            exit 1
          fi

          if [ "$level" = "BYPASSED" ]; then
             echo "⚠️ HIGH risk but BYPASSED — passing"
             exit 0
          fi

          echo "✅ $level risk — passing"
