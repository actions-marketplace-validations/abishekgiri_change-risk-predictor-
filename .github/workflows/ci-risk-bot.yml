name: RiskBot CI

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  riskbot:
    name: RiskBot CI   # THIS MUST MATCH BRANCH PROTECTION EXACTLY
    runs-on: ubuntu-latest

    steps:
      - name: Call RiskBot webhook + enforce HIGH risk
        env:
          WEBHOOK_URL: ${{ secrets.RISKBOT_WEBHOOK_URL }}
        run: |
          set -euo pipefail

          if [ -z "${WEBHOOK_URL:-}" ]; then
            echo "ERROR: RISKBOT_WEBHOOK_URL secret is not set."
            exit 2
          fi

          echo "Calling RiskBot at $WEBHOOK_URL"
          resp=$(curl -sS -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{}")

          echo "Raw response:"
          echo "$resp"

          level=$(python3 - <<PY
import json
data = json.loads("""$resp""")
print((data.get("level") or data.get("risk_level") or "").upper())
PY
          )

          echo "Parsed level: $level"

          if [ "$level" = "HIGH" ]; then
            echo "❌ HIGH risk — blocking merge"
            exit 1
          fi

          echo "✅ $level risk — passing"
