name: RiskBot CI

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  riskbot:
    name: RiskBot CI
    runs-on: ubuntu-latest

    steps:
      - name: Call RiskBot CI Score
        env:
          WEBHOOK_BASE: ${{ secrets.RISKBOT_WEBHOOK_URL }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          if [ -z "${WEBHOOK_BASE:-}" ]; then
            echo "ERROR: RISKBOT_WEBHOOK_URL secret is not set."
            exit 3
          fi

          # Sanitize WEBHOOK_BASE: remove newlines/returns and leading/trailing whitespace
          WEBHOOK_BASE=$(echo "$WEBHOOK_BASE" | tr -d '\n' | tr -d '\r' | xargs)

          # Ensure we hit the correct endpoint
          URL="${WEBHOOK_BASE%/}/ci/score"
          echo "Debug: Constructed URL: $URL"

          # Call RiskBot (ngrok header avoids ngrok HTML warning page)
          resp="$(curl -sS -X POST "$URL" \
            -H "Content-Type: application/json" \
            -H "ngrok-skip-browser-warning: true" \
            -d "{\"repo\":\"$REPO\",\"pr\":$PR_NUMBER,\"sha\":\"$SHA\"}")"

          echo "Raw response:"
          echo "$resp"

          # Parse level from common keys (supports level or risk_level)
          level="$(echo "$resp" | jq -r '.level // .risk_level // .riskLevel // empty')"

          if [ -z "$level" ]; then
            echo "ERROR: Could not find risk level in response JSON."
            echo "Expected keys: level or risk_level"
            exit 4
          fi

          echo "Parsed risk level: $level"

          if [ "$level" = "HIGH" ]; then
            echo "HIGH risk => failing check"
            exit 1
          fi

          echo "Not HIGH => passing check"
