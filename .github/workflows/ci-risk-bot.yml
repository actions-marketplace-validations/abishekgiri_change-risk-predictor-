name: RiskBot CI

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  riskbot:
    name: RiskBot CI   # THIS MUST MATCH BRANCH PROTECTION EXACTLY
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      checks: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # we need history for churn analysis

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install RiskBot
        run: |
          pip install --upgrade pip
          pip install -e .

      - name: Run RiskBot Analysis
        env:
          # Use the built-in GITHUB_TOKEN for API access logic in cli.py
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Report-only mode (EXIT 0 even on FAIL) for initial rollout/release PRs
          RISKBOT_ENFORCEMENT: report_only
        run: |
          echo "Running RiskBot analysis for PR #${{ github.event.pull_request.number }}"
          
          # The CLI will exit 0 (PASS), 1 (FAIL), or 2 (WARN)
          # We capture the exit code to allow for "soft" failures if needed, 
          # but here we just let it fail the step naturally if exit code != 0.
          
          riskbot analyze-pr \
            --repo "${{ github.repository }}" \
            --pr "${{ github.event.pull_request.number }}" \
            --output "risk_report.json"
